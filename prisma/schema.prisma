// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum RoleTag {
  HR
  INTERVIEWER
  RECRUITER
  TRAINER
  FINANCE
}

enum NotificationScope {
  DIRECT
  TEAMLEADS_SUBDEPT
  MANAGERS_DEPT
  DIRECTORS_HR
}

model SubRole {
  id          String              @id @default(cuid())
  name        String              @unique
  description String?
  users       User[]              @relation("UserSubRole")
  level       Int
  permissions SubRolePermission[] // ðŸ‘ˆ This is the join relation
}

model Permission {
  id          String              @id @default(uuid())
  module      String
  action      String
  description String?
  roles       RolePermission[]
  users       UserPermission[]
  subRoles    SubRolePermission[] // ðŸ‘ˆ Join relation only

  @@unique([module, action], name: "module_action")
}

model RolePermission {
  id           String     @id @default(uuid())
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       String
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId String

  @@unique([roleId, permissionId], name: "roleId_permissionId")
}

model SubRolePermission {
  id           String @id @default(cuid())
  subRoleId    String
  permissionId String

  subRole    SubRole    @relation(fields: [subRoleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([subRoleId, permissionId], name: "subRole_permission")
}

model UserPermission {
  id           String     @id @default(uuid())
  user         User       @relation(fields: [userId], references: [id])
  userId       String
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId String

  @@unique([userId, permissionId], name: "userId_permissionId")
}

model User {
  id                    String                 @id @default(uuid())
  username              String                 @unique
  passwordHash          String
  email                 String                 @unique
  fullName              String
  role                  Role                   @relation(fields: [roleId], references: [id])
  roleId                String
  status                String
  dateJoined            DateTime               @default(now())
  lastLogin             DateTime?
  subRoleId             String?
  subRole               SubRole?               @relation("UserSubRole", fields: [subRoleId], references: [id])
  roleTag               RoleTag?
  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?
  employee              Employee?

  approvedLeaves        LeaveRequest[]         @relation("ApprovedBy")
  approvedVacations     Vacation[]             @relation("ApprovedBy")
  assignedOnboarding    OnboardingProcess[]    @relation("AssignedHR")
  processedResignations Resignation[]          @relation("ProcessedBy")
  initiatedHRProcesses  HRProcess[]            @relation("InitiatedBy")
  UserPermission        UserPermission[]
  SystemLog             SystemLog[]
  BulkUpload            BulkUpload[]
  Resignation           Resignation[]
  Notification          Notification[]
  AttendanceFixRequest  AttendanceFixRequest[]
  UserNotification      UserNotification[]
}

model Employee {
  id                    String         @id @default(uuid())
  user                  User           @relation(fields: [userId], references: [id])
  userId                String         @unique
  employeeNumber        String         @unique
  department            Department?    @relation(fields: [departmentId], references: [id])
  departmentId          String?
  position              String
  dateOfBirth           DateTime
  hireDate              DateTime
  status                String
  fatherName            String?
  manager              Employee?              @relation("EmployeeManager", fields: [managerId], references: [id])
  managerId            String?
  skills               String? // JSON string of skills array
  subDepartment         SubDepartment? @relation(fields: [subDepartmentId], references: [id])
  subDepartmentId       String?
  address               String
  emergencyContactName  String
  emergencyContactPhone String
  gender                String
  salary                Decimal        @db.Decimal(10, 2)
  workLocation          String // Onsite, Remote, Hybrid
  phoneNumber           String?
  shiftId               String?
  shift                 Shift?         @relation(fields: [shiftId], references: [id])

  profileImageUrl      String?
  images               Json? // Stores array of image objects [{name, url, mimeType, uploadedAt}]
  documents            Json? // Stores array of document objects [{name, url, mimeType, type, uploadedAt, categoryId}]

  managedEmployees     Employee[]             @relation("EmployeeManager")
  attendanceRecords    AttendanceRecord[]
  leaveRequests        LeaveRequest[]
  vacations            Vacation[]
  onboardingProcesses  OnboardingProcess[]
  resignations         Resignation[]
  assets               Asset[]
  hrProcesses          HRProcess[]
  LeaveBalance         LeaveBalance[]
  AttendanceFixRequest AttendanceFixRequest[]
  salaryDetails        SalaryDetail[]
}

model Role {
  id             String           @id @default(uuid())
  name           String           @unique
  description    String?
  users          User[]
  RolePermission RolePermission[]
}

model SubDepartment {
  id           String     @id @default(uuid())
  name         String     @unique
  description  String?
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId String
  employees    Employee[]
}

model Department {
  id             String          @id @default(uuid())
  name           String          @unique
  description    String?
  employees      Employee[]
  subDepartments SubDepartment[]
}

model AttendanceRecord {
  id                   String                 @id @default(uuid())
  employee             Employee               @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId           String
  date                 DateTime
  clockIn              DateTime
  clockOut             DateTime?
  shift                Shift                  @relation(fields: [shiftId], references: [id])
  shiftId              String
  absenceReason        String?
  netWorkingMinutes    Int? // <-- Add this
  lateMinutes          Int?
  status               String
  breaks               Break[]
  AttendanceFixRequest AttendanceFixRequest[]
}

model Shift {
  id                String             @id @default(uuid())
  name              String             @unique
  startTime         DateTime
  endTime           DateTime
  description       String?
  attendanceRecords AttendanceRecord[]
  employees         Employee[]
}

model LeaveRequest {
  id           String    @id @default(uuid())
  employee     Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId   String
  leaveType    LeaveType @relation(fields: [leaveTypeId], references: [id])
  leaveTypeId  String
  startDate    DateTime
  endDate      DateTime
  reason       String
  status       String
  requestedAt  DateTime  @default(now())
  approvedBy   User?     @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedById String?
  approvedAt   DateTime?
}

model LeaveType {
  id            String         @id @default(uuid())
  name          String         @unique
  description   String?
  isPaid        Boolean        @default(true)
  leaveRequests LeaveRequest[]
  LeaveBalance  LeaveBalance[]
  totalDays     Int
}

model Break {
  id                 String           @id @default(uuid())
  attendanceRecord   AttendanceRecord @relation(fields: [attendanceRecordId], references: [id])
  attendanceRecordId String
  breakStart         DateTime
  breakEnd           DateTime?
  breakTypeId        String?
  breakType          BreakType?       @relation(fields: [breakTypeId], references: [id])
}

model Notification {
  id              String             @id @default(uuid())
  title           String
  message         String
  type            String
  createdAt       DateTime           @default(now())
  visibilityLevel Int?
  departmentId    String?
  subDepartmentId String?
  employeeId      String?
  scope           NotificationScope?

  userNotifications UserNotification[] // ðŸ‘ˆ new relation
  User              User?              @relation(fields: [userId], references: [id])
  userId            String?
}

model UserNotification {
  id             String       @id @default(uuid())
  user           User         @relation(fields: [userId], references: [id])
  userId         String
  notification   Notification @relation(fields: [notificationId], references: [id])
  notificationId String
  read           Boolean      @default(false)
  readAt         DateTime?
}

model AttendanceFixRequest {
  id         String   @id @default(uuid())
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  requestType       String // "CheckIn", "CheckOut", "Both", etc.
  requestedCheckIn  DateTime? // Optional: requested fixed clockIn
  requestedCheckOut DateTime? // Optional: requested fixed clockOut
  requestedBreaks   Json? // Optional JSON for break updates if needed

  reason      String
  status      String // "Pending", "Approved", "Rejected"
  requestedAt DateTime @default(now())

  reviewedBy   User?     @relation(fields: [reviewedById], references: [id])
  reviewedById String?
  reviewedAt   DateTime?

  remarks            String? // Optional comment from reviewer
  AttendanceRecord   AttendanceRecord? @relation(fields: [attendanceRecordId], references: [id])
  attendanceRecordId String?
}

model SalaryDetail {
  id         String   @id @default(uuid())
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  baseSalary Decimal @db.Decimal(10, 2)
  deductions Decimal @default(0.00) @db.Decimal(10, 2)
  bonuses    Decimal @default(0.00) @db.Decimal(10, 2)
  totalPay   Decimal @db.Decimal(10, 2)

  allowances Allowance[] // ðŸ‘ˆ One-to-many

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdBy String
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Allowance {
  id       String       @id @default(uuid())
  salary   SalaryDetail @relation(fields: [salaryId], references: [id], onDelete: Cascade)
  salaryId String

  type   String
  amount Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
}
